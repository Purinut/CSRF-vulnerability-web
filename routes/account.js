const passport = require('passport');
const router = require('express').Router();
const User = require('../models/User');

router.get('/', (req, res) => {
  res.redirect('/account');
})

router.get('/account', async (req, res) => {
  if(req.isAuthenticated()) {
    try {
      const userInfo = await User.findById(req.user._id);
      res.render('account', {amount: userInfo.amount});
    } catch (err) {
      res.send('Cannot render this page...');
    }
  }
  res.redirect('/login');
})

router.get('/deposit', async (req, res) => {
  if(req.isAuthenticated()) {    
    try {
      //get user data
      const userInfo = await User.findById(req.user._id);
      let money = parseFloat(userInfo.amount) + parseFloat(req.query.amount);
      //update user amount
      const result = await User.findByIdAndUpdate(req.user._id, { $set: {amount: money} });
      res.redirect('/account');
    } catch (err) {
      res.send('There is some errors on Deposit');
    }

  } else {
    res.redirect('/login');
  }
});

router.get('/transfer', async (req, res) => {
  if(req.isAuthenticated()) {    
    try {
      //get user data
      const userInfo = await User.findById(req.user._id);
      
      //check amount of money
      const remain = +userInfo.amount;
      const amount = +req.query.amount;
      if (remain < amount) {
        res.send('You don\'t have enough money');
      } else {
        //deduce user's money
        let currentRemain = remain - amount;
        await User.findByIdAndUpdate(req.user._id, { $set: {amount: currentRemain} });
        
        console.log('Above is OK');
        //get destination user data
        const destUser = await User.findOne({username: req.query.to});
        const destAmount = +destUser.amount;
        //add money to destination user
        const currentDestAmount = destAmount + amount;
        await User.findByIdAndUpdate(destUser._id, { $set: {amount: currentDestAmount} });
        res.redirect('/account');
      }
    } catch (err) {
      res.send('There is some errors on Transfer');
    }

  } else {
    res.redirect('/login');
  }
});

module.exports = router;